var map = L.map('map').setView([60.16, 24.95], 13);

L.tileLayer('http://{s}.tile.cloudmade.com/c3f9f79471e64cd8b7de37c42b2aa752/115732/256/{z}/{x}/{y}.png', {
  attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery &copy; <a href="http://cloudmade.com">CloudMade</a>',
  maxZoom: 18
}).addTo(map);

// Polygons representing the areas we want to compare
var areas = [{
  type: 'Feature',
  properties: {
    name: 'area1',
    // old and new classes for comparison
    classification: [0, 1]
  },
  geometry: {
    type: 'Polygon',
    coordinates: [[
      [ 24.966821701487,60.16259488508 ],
      [ 24.9632113650572,60.1625960273247 ],
      [ 24.9603794029289,60.1637367733103 ],
      [ 24.958037787336,60.1646798082926 ],
      [ 24.9578744744819,60.1659408869472 ],
      [ 24.9576015578152,60.1680475071151 ],
      [ 24.957714873007,60.1681421259349 ],
      [ 24.9567920902363,60.1681135044304 ],
      [ 24.9550710341367,60.1680758154034 ],
      [ 24.9550719805393,60.1680674589477 ],
      [ 24.9535234858185,60.1680306614287 ],
      [ 24.9522419297901,60.1679952508015 ],
      [ 24.952096775346,60.1679963830265 ],
      [ 24.9512341496402,60.1679716003483 ],
      [ 24.9509149378641,60.1679661690034 ],
      [ 24.9504237152986,60.1679529919532 ],
      [ 24.950057959583,60.1679413381732 ],
      [ 24.9495558892059,60.1679281458604 ],
      [ 24.9493015366149,60.1679250293119 ],
      [ 24.9457889598211,60.1678368292171 ],
      [ 24.9455320222108,60.1678264516238 ],
      [ 24.9422187951135,60.1677451745817 ],
      [ 24.94119684791,60.1677192142494 ],
      [ 24.9405661544488,60.1681346169859 ],
      [ 24.9404080323809,60.1682436552126 ],
      [ 24.9382367729163,60.1696835003528 ],
      [ 24.9380679525861,60.1696210402607 ],
      [ 24.9379146669511,60.1697334528687 ],
      [ 24.9375839185369,60.1699756864118 ],
      [ 24.9363123353965,60.1708205310791 ],
      [ 24.9361225222218,60.1709501680407 ],
      [ 24.9356618423404,60.1712651384927 ],
      [ 24.935634094487,60.1712875999231 ],
      [ 24.9356474549716,60.1713079756593 ],
      [ 24.9356496062375,60.1713366005414 ],
      [ 24.9356208903721,60.1713772942933 ],
      [ 24.9349947053645,60.1720295691965 ],
      [ 24.9349492141799,60.172076216829 ],
      [ 24.9347111383517,60.1719774306605 ],
      [ 24.9343418998156,60.1720486254989 ],
      [ 24.9339512307585,60.1721241001624 ],
      [ 24.9337998314779,60.1723667663908 ],
      [ 24.9339188065577,60.1723851415464 ],
      [ 24.9335536152915,60.1729712878265 ],
      [ 24.9334347868874,60.1729529113032 ],
      [ 24.9332430131545,60.1732605929266 ],
      [ 24.9337938691108,60.1733457773026 ],
      [ 24.9333885297976,60.1737640464583 ],
      [ 24.9349676136512,60.174471436839 ],
      [ 24.9328755008295,60.1780496556592 ],
      [ 24.9326075644573,60.1780105104568 ],
      [ 24.9320723303123,60.1789098351137 ],
      [ 24.9350061620542,60.1800449287599 ],
      [ 24.938661347497,60.1799077799444 ],
      [ 24.9435058217409,60.1797258028868 ],
      [ 24.9434323398463,60.1777332825121 ],
      [ 24.9493410258519,60.176358856613 ],
      [ 24.9503648751287,60.1763793549457 ],
      [ 24.9511247261397,60.1763943771334 ],
      [ 24.9533307062883,60.1770962450372 ],
      [ 24.9536480164986,60.1771971217745 ],
      [ 24.9548434564361,60.1772286515468 ],
      [ 24.9581117423495,60.177314970072 ],
      [ 24.9664755661475,60.1762783563446 ],
      [ 24.9768102737668,60.1749966887559 ],
      [ 24.976966991512,60.1745478848433 ],
      [ 24.9785881625528,60.1699092300427 ],
      [ 24.9790560067308,60.1685703682468 ],
      [ 25.0032227889254,60.1685575979946 ],
      [ 25.0044657389058,60.1625764432651 ],
      [ 24.966821701487,60.16259488508 ]
    ]]
  }
}, {
  type: 'Feature',
  properties: {
    name: 'area2',
    classification: [1, 0]
  },
  geometry: {
    type: 'Polygon',
    coordinates: [[
      [ 24.9404575841116,60.1644434174326 ],
      [ 24.9381326347829,60.1636305835842 ],
      [ 24.937916557273,60.1635563373702 ],
      [ 24.9356250590206,60.1627502262595 ],
      [ 24.9342271804183,60.1622674568818 ],
      [ 24.9330889875771,60.1630826026586 ],
      [ 24.9315116125353,60.162530320727 ],
      [ 24.9299194644354,60.1619844085078 ],
      [ 24.9296418431141,60.1619447870995 ],
      [ 24.9288920454397,60.1617103281908 ],
      [ 24.9275375547185,60.1612384074195 ],
      [ 24.9272494034992,60.1604710018362 ],
      [ 24.9250048647766,60.1607325023038 ],
      [ 24.9249111870171,60.1546676546402 ],
      [ 24.9166372097783,60.1466265440541 ],
      [ 24.8981103729171,60.1466246438159 ],
      [ 24.8972105606594,60.1466244538187 ],
      [ 24.897210292774,60.1476726440919 ],
      [ 24.8972102811382,60.1539819721211 ],
      [ 24.8972094027951,60.1575543434198 ],
      [ 24.897209443875,60.1587828090311 ],
      [ 24.8972091947415,60.1619527777914 ],
      [ 24.8972089427806,60.1658968312734 ],
      [ 24.8951564859091,60.1667413521617 ],
      [ 24.8822163108421,60.1721108383382 ],
      [ 24.8989781578908,60.1817389640018 ],
      [ 24.8998793449776,60.1813466181145 ],
      [ 24.9063360066326,60.1785354437482 ],
      [ 24.9120993858623,60.1760255329862 ],
      [ 24.9173809446244,60.1766356097193 ],
      [ 24.9211896098762,60.1770754372907 ],
      [ 24.9220670665935,60.1770808310017 ],
      [ 24.9226022554169,60.1770566387093 ],
      [ 24.9253613061177,60.1773647545992 ],
      [ 24.9270663000684,60.1775552116269 ],
      [ 24.9279533978606,60.1776542299612 ],
      [ 24.9291665198188,60.1777859728835 ],
      [ 24.9297368901107,60.1780018479668 ],
      [ 24.9309852258425,60.1784895768966 ],
      [ 24.9320723303123,60.1789098351137 ],
      [ 24.9326075644573,60.1780105104568 ],
      [ 24.9328755008295,60.1780496556592 ],
      [ 24.9349676136512,60.174471436839 ],
      [ 24.9333885297976,60.1737640464583 ],
      [ 24.9337938691108,60.1733457773026 ],
      [ 24.9332430131545,60.1732605929266 ],
      [ 24.9334347868874,60.1729529113032 ],
      [ 24.9335536152915,60.1729712878265 ],
      [ 24.9339188065577,60.1723851415464 ],
      [ 24.9337998314779,60.1723667663908 ],
      [ 24.9339512307585,60.1721241001624 ],
      [ 24.9343418998156,60.1720486254989 ],
      [ 24.9347111383517,60.1719774306605 ],
      [ 24.9349492141799,60.172076216829 ],
      [ 24.9349947053645,60.1720295691965 ],
      [ 24.9356208903721,60.1713772942933 ],
      [ 24.9356496062375,60.1713366005414 ],
      [ 24.9356474549716,60.1713079756593 ],
      [ 24.935634094487,60.1712875999231 ],
      [ 24.9356618423404,60.1712651384927 ],
      [ 24.9361225222218,60.1709501680407 ],
      [ 24.9363123353965,60.1708205310791 ],
      [ 24.9375839185369,60.1699756864118 ],
      [ 24.9379146669511,60.1697334528687 ],
      [ 24.9380679525861,60.1696210402607 ],
      [ 24.9382367729163,60.1696835003528 ],
      [ 24.9404080323809,60.1682436552126 ],
      [ 24.9405661544488,60.1681346169859 ],
      [ 24.94119684791,60.1677192142494 ],
      [ 24.9415374231994,60.1674949475488 ],
      [ 24.9432295423655,60.166363621543 ],
      [ 24.943393204162,60.166251487862 ],
      [ 24.943428909295,60.1658069977462 ],
      [ 24.9434546414611,60.1654863864726 ],
      [ 24.9427891462633,60.1652548172008 ],
      [ 24.9425722919642,60.1651801351146 ],
      [ 24.9412518554803,60.1647211292752 ],
      [ 24.9404575841116,60.1644434174326 ]
    ]]
  }
}];

// What color to assign a given class
var classToColor = ['#009900', '#AA6600'];

L.geoJson(areas, {
  weight: 1,
  opacity: 0.7,
  fillOpacity: 0.4,
  style: function(feature) {
    // Color using the first (old) class
    return {color: classToColor[feature.properties.classification[0]]};
  },
  // Left region of map
  clipPath: 'url(#clipLeft)'
}).addTo(map);

L.geoJson(areas, {
  weight: 1,
  opacity: 0.7,
  fillOpacity: 0.4,
  style: function(feature) {
    // Color using the second (new) class
    return {color: classToColor[feature.properties.classification[1]]};
  },
  // Right region of map
  clipPath: 'url(#clipRight)'
}).addTo(map);

// Assign clip paths to all appropriate Leaflet layers
for (var i in map._layers) {
  if (map._layers[i]._container) {
    map._layers[i]._container.style.clipPath = 
      map._layers[i].options.clipPath;
  }
}

function moveSwipe(map, swipe, x) {
  x = Math.max(0, Math.min(x, map.getSize()['x']));
  var handle = swipe.getElementsByTagName('div')[0];
  swipe.style.width = x + 'px';
  handle.style.left = (x - handle.getBoundingClientRect().width/2) + 'px';
};

function setDivide(map, clipLeft, clipRight, x) {  
  x = Math.max(0, Math.min(x, map.getSize()['x']));
  var layerX = map.containerPointToLayerPoint(x, 0).x,
    clipLeftRect = clipLeft.getElementsByTagName('rect')[0],
    clipRightRect = clipRight.getElementsByTagName('rect')[0];

  // TODO: somehow gets negative width, cuts off left rectangle. 
  // Check console logs  when scrolling map left.
  clipLeftRect.setAttribute('width', layerX);
  clipRightRect.setAttribute('x', layerX);
};

var swipe = document.getElementById('swipe'),
  handle = swipe.getElementsByTagName('div')[0];
  dragging = false;

setDivide(map, 
          document.getElementById('clipLeft'), 
          document.getElementById('clipRight'), 
          handle.getBoundingClientRect().left);

swipe.getElementsByTagName('div')[0].onmousedown = function() {
  dragging = true;
}

document.onmouseup = function() {
  dragging = false;
}

document.onmousemove = function(e) {
  if (dragging) {
    // TODO: The divide "jumps" a bit if you grab the handle off-center
    moveSwipe(map, swipe, e.x || e.pageX);
    setDivide(map, 
              document.getElementById('clipLeft'), 
              document.getElementById('clipRight'),
              handle.getBoundingClientRect().left);
  }
}
